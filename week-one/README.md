# 项目性能优化

- 目标01-了解应用性能问题分析方法论

- 目标02-掌握压力测试基础概念：RT、TPS、Active Thread...

- 目标03-掌握压力测试：线程组配置、结果分析，插件使用

- 目标04-理解性能关键的指标

- 目标05-掌握压测监控平台搭建



## 性能问题分析

### 性能优化的终极目标

用户体验 = 产品设计(非技术) + 系统性能 ≈ 系统性能 = 快？

- **3S定理**：Strangeloop在对众多的网站做性能分析之后得出了一个著名的3s定律“页面加载速度超过3s，57%的访客会离开”。
- **SEO排名**：速度在Google、百度等搜索引擎的PR评分中也占有一定的比例，会影响到网站的SEO排名。

### 应用性能调优

- 后端：RT、TPS、并发数、Throughput、Footprint、Latency
  - TPS和RT的影响因素：数据库读写、RPC、网络IO、逻辑计算复杂度、JVM
- Web端：首屏时间（DNS，建立连接，后端接口返回数据相应时间，网络传输时间，首屏页面渲染页面时间）、白屏时间、可交互时间、完全加载时间...
- 移动端：端到端响应时间、Crash率、内存使用率、FPS...

### 影响性能的关键要素

- 产品设计：产品逻辑、功能交互、动态效果、页面元素
  - 举例：按钮按一次后disabled几秒，防连续点击多次无效后端请求
- 基础网络：网络 = 连接介质 + 计算终端
  - 连接介质：电缆、双绞线、光纤、微波、载波或通信卫星。
  - 计算终端：PC、手机、可穿戴设备、家具家电...
  - 基础网络设施，互联网，局域网(LAN)、城域网(MAN)、广域网(WAN)
- 代码质量&架构
  - 架构不合理
  - 研发功底和经验不足
  - 没有性能意识：只实现了业务功能不注意代码性能，新功能上线后整体性能下降，或当业务上量后系统出现连锁反应，导致性能问题叠加，直接影响用户体验。
    - 相关：阿里规约
  - 数据库：慢查询、过多查询、索引使用不当、数据库服务器瓶颈...
- 移动端环境
- 硬件及云服务



## 压力测试

**压力测试**（Stress testing）是针对特定系统或是组件，为要确认其稳定性而特意进行的严格测试。会让系统在超过正常使用条件下运作，然后再确认其结果。

压力测试是对系统不断施加压力，来预估系统服务能力的一种测试。

- 一般而言，只有在系统基础功能测试验证完成、系统趋于稳定的情况下，才会进行压测。

### 目的

1. 当负载逐渐增加时，观察**系统各项性能指标的变化情况**是否有异常

2. 发现系统的**性能短板**，进行针对性的性能优化

3. 判断系统在**高并发情况下是否会报错**，进程是否会挂掉

4. 测试在系统某个方面达到瓶颈时，粗略估计系统性能上限

### 指标

![指标1](.\note\指标1.png)

![指标2](.\note\指标2.png)

在这个图中，定义了**三条曲线、三个区域、两个点以及三个状态**描述。

- 三条曲线：
  - 吞吐量的曲线（紫色）
  - 利用率（绿色）
  - 响应时间曲线（深蓝色）

- 三个区域：
  - 轻负载区（Light Load）
  - 重负载区（Heavy Load）
  - 塌陷区（Buckle Zone）

- 两个点：
  - 最优并发用户数（The Optimum Number of Concurrent Users）
  - 最大并发用户数（The Maximum Number of Concurrent Users）

- 三个状态描述：
  - 资源饱和（Resource Saturated）
  - 吞吐下降（Throughput Falling）
  - 用户受影响（End Users Effected）

**常用压测工具：**

1. **Apache JMeter :** **可视化的测试工具**

   - Apache JMeter是Apache组织开发的基于Java的压力测试工具。用于对软件做压力测试，它最初被设计用于Web应用测试，但后来扩展到其他测试领域。 它可以用于测试**静态和动态资源**，例如静态文件、**Java** **小服务程序**、**CGI** **脚本**、**Java** **对象**、**数据库**、**FTP** **服务器**， 等等。

     官网地址：https://jmeter.apache.org/

     中文社区：http://www.jmeter.com.cn/2747.html

2. Apache的ab压力测试

3. Nginter 韩国研发

4. PAS 阿里测试工具

5. MeterSphere ：国内持续测试的开源平台

6. ...

### 目标

- 负载上升各项指标是否正常
- 发现性能短板
- 高并发下系统是否稳定
- 预估系统最大负载能力

## 创建压测案例

![Jmeter启动](.\note\Jmeter启动.png)

完成压测案例，评测SpringBoot项目的吞吐量（TPS）上限。

- 选择测试计划 → 右键 → 添加 → 线程（用户）→ 线程组（线程组可根据自己的需要进行重命名）

![配置线程组](.\note\配置线程组.png)

- 选中线程组名称 → 右键 → 添加 → 取样器 → http请求（用来发送请求）
  - 配置http接口：[http://47.95.217.81:9001/spu/goods/10000005620800](http://47.95.217.81:9001/spu/goods/10000005620800)
  - 选择keepalive方式，表示使用了长连接。使用长连接可以防止频繁的建立连接，关闭连接消耗性能。一般浏览器都支持keepalive，如果这里不勾选，这样我们的压测的部分性能消耗会发生在建立，关闭连接上，导致我们的压测数据不准确。

![配置http接口](.\note\配置http接口.png)

![配置http接口2](.\note\配置http接口2.png) 

- 选中线程组名称 → 右键 → 添加 → 断言 → 响应断言
  - JMeter断言常用有两种，一种是**响应断言**，一种是**响应时间断言**，如果响应内容不满足断言的配置，则认为这次的请求是失败的。
    - 响应断言：判断响应内容是否包含指定的字符信息，用于判断api接口返回内容是否正确。
    - 响应时间断言：判断响应时间，是否超过预期的时间，用于判断api接口返回时间是否超过预期。

- 选中线程组名称 → 右键 → 添加 → 监听器 → 查看结果树（用来查看请求是否成功）
- 聚合报告：查询结果信息聚合汇总，例如样本、平均值、通吐量、最大值、最小值...
- 察看结果树：记录每一次压测请求
- 图像结果：分析了所有请求的平均值、终止、偏离值和通吐量之间的关系。
- 汇总结果：汇总压测结果
- 汇总图：将压测结果以图像形式展示
- ...等等其他配置

![其他监听配置](.\note\其他监听配置.png) 

## 压测结果

### 聚合报告

- 样本（sample）: 发送请求的总样本数量

- 响应时间【单位ms】：
  - 平均值（average）：平均的响应时间
  - 中位数（median）: 中位数的响应时间，50%请求的响应时间
  - 90%百分位（90% Line）: 90%的请求的响应时间，意思就是说90%的请求是<=1765ms返回，另外10%的请求是大于等于1765ms返回的。 
  - 95%百分位（95% Line）: 95%的请求的响应时间，95%的请求都落在1920ms之内返回的
  - 99%百分位（99% Line）: 99%的请求的响应时间
  - 最小值(min)：请求返回的最小时间，其中一个用时最少的请求
  - 最大值(max)：请求返回的最大时间，其中一个用时最大的请求

- 异常（error）: 出现错误的百分比，错误率=错误的请求的数量/请求的总数

- 吞吐量TPS（throughout）: 吞吐能力

- Received KB/sec----每秒从服务器端接收到的数据量

- Sent KB/sec----每秒从客户端发送的请求的数量

### 结果树

图形结果：分析了所有请求的平均值、终止、偏离值和通吐量之间的关系

横坐标：为请求数量，单位个数

纵坐标：响应时间，单位ms

### 汇总报告【类似于聚合报告】

- 样本（sample）: 发送请求的总样本数量

- 响应时间【单位ms】：
  - 平均值（average）：平均的响应时间

  - 最小值(min)：请求返回的最小时间，其中一个用时最少的请求

  - 最大值(max)：请求返回的最大时间，其中一个用时最大的请求

  - 标准偏差：度量响应时间分布的分散程度的标准，衡量响应时间值偏离平均响应时间的程度。

    标准偏差越小，偏离越少，反之亦然。

- 异常（error）: 出现错误的百分比，错误率=错误的请求的数量/请求的总数

- 吞吐量TPS（throughout）: 吞吐能力，这个才是我们需要的并发数
- 每秒接收 KB/sec----每秒从服务器端接收到的数据量

- 每秒发送KB/sec----每秒从客户端发送的请求的数量

- 平均字节数

### 线程组配置详解

- 线程数：用来发送http请求的线程的数量
  - 线程组常用来模拟一组用户访问系统资源（API接口）。
  - 假如客户机没有足够的能力来模拟较重的负载，可以使用JMeter的分布式测试功能，通过一个JMeter的Master来远程控制多个JMeter的Salve完成测试。

循环次数：循环执行多少次操作

- 循环次数表示了循环执行多少次操作！循环次数直接决定整个测试单个线程的执行时间，和整体测试执行时间。
  - **单线程执行时间** = 单请求平均响应时间 * 循环次数
  - **整个测试耗时** = 单线程执行时间 + (Ramp-Up - Ramp-Up / 线程数)

- Ramp-Up：建立全部线程耗时
  - Ramp-Up Period (in-seconds) 代表隔多长时间执行，默认值是0，0代表同时并发。用于告知JMeter 要在多长时间内建立全部的线程。

## 压测监控平台

服务器配置4核（vCPU）8GiB CentOS 7.6 64位

使用 `FinalShell` 建立连接

### 阿里云服务器配置docker

1）yum 包更新到最新

```shell
sudo yum update
```

2）安装需要的软件包， yum-util 提供yum-config-manager功能，另外两个是devicemapper驱动依赖的

```shell
sudo yum install -y yum-utils device-mapper-persistent-data lvm2
```

3）设置yum源为阿里云

配置yum源的代理，类似于maven镜像仓库，加速下载软件。

```shell
sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
```

4）安装docker

```shell
sudo yum install docker-ce
# 启动
systemctl start docker
# 状态
systemctl status docker
```

5）安装后查看docker版本

```shell
docker -v
```

### 安装InfluxDB

1）下载InfluxDB的镜像：

```shell
docker pull influxdb:1.8
```

2）启动InfluxDB的容器，并将端口 8083 和 8086 映射出来：

```shell
docker run -d --name influxdb -p 8086:8086 -p 8083:8083 influxdb:1.8
```

3）进入容器内部，创建名为jmeter的数据库：

进入 jmeter-influx 容器

```shell
docker exec -it influxdb /bin/bash
```

- 输入`influx`命令，即可进入 influx 操作界面
- 输入`create database jmeter` 命令，创建名为 jmeter 的数据库
- 输入`show databases` 命令，查看数据库创建成功

```bash
root@517f57017d99:/# influx
Connected to http://localhost:8086 version 1.7.10
InfluxDB shell version: 1.7.10
> create database jmeter
> show databases
```

4）使用JMeter 库， select 查看数据，这个时候是没有数据的：

- 输入`use jmeter`命令，应用刚才创建的数据库
- 输入`select * from jmeter`命令，查询库中有哪些数据

```bash
> use jmeter
> select * from jmeter
```

